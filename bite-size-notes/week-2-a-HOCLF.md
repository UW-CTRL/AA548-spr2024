# High Order Control Lyapunov Function (HOCLF)

## Scope and objectives
The note will introduce how the control Lyapunov function could be used to enforce convergence of a system and can be used to reduce the optimal control problem to a sequence of quadratic programs
(QPs).

## Introduction
In the realm of optimal control, the Linear Quadratic Regulator(LQR) was typically used to find the optimal control law that uses minimum control effort to reach an objective for a linear system. For the non-linear system, in order to stabilize the dynamic system while optimizing cost and satisfying safety constraints and control limitations, the control Lyapunov function (CLFs) was typically used to enforce convergence and reduce the optimal control problem to a sequence of quadratic programs(QP). In a trajectory-tracking example, the quadratic programs problem could be formulated as minimizing the quadratic error between the desired control law, which is typically generated by higher-level controllers, and the purposed control law under certain constraints. The carefully designed control Lyapunov function could act as a constraint to guarantee forward invariance of the control to guide the system to the desired location.  

## Preliminaries
### Control Lyapunov Function(CLF)
A CLF is a function $V: \mathcal{D} \to \mathbb{R}$ that is continuously differentiable and positive definite where $\exists u \in \mathcal{U}$ such that $\dot{V}(x) = \nabla V(x)^\top f(x,u) \leq 0$ for $\dot{x} = f(x,u)$ (asymptotically stable), or $\nabla V(x)^\top f(x,u) \leq -\alpha V(x)$ for some $\alpha > 0$ (exponentially stable). \
Essentially, 

$$
\inf_{u \in \mathcal{U}} \nabla V(x)^\top f(x,u) \leq -\alpha V(x) \quad \forall x \in \mathcal{D}
$$

### Control Invariant Set
A set $\Omega$ is a Control invariant set with respect to $\dot{x} = f(x,u)$ if there exists $u \in \mathcal{U}$ (dynamic) such that if $x(0) \in \Omega$, then $x(t) \in \Omega$ for all $t \geq 0$.\
There exists a control u that keeps the system inside $\Omega$.

### Control Affine system
A dynamic system of the following form is a control affine system: 
$\dot{x} = f(x) + g(x)u$.\
where
$x \in \mathbb{R}^n$ is the state vector,
$u \in \mathbb{R}^m$ is the control input vector,
$f(x): \mathbb{R}^n \to \mathbb{R}^n$ is a continuously differentiable autonomous vector field, 
$g(x): \mathbb{R}^n \to \mathbb{R}^{n\times m}$ is a continuously differentiable control matrix.

### Relative Degree
The relative degree $m$ of a sufficiently differentiable function $V: \mathbb{R}^n \to \mathbb{R}$ with respect to the dynamics $\dot{x} = f(x) + g(x)u$ such that

$$
L_g L_f^{m-1} V \neq 0
$$

but

$$
L_g L_f^{m-2} V = 0.
$$


Intuitively, the relative means how many times you need to differentiate input to get output

### Quadratic Program
$$
Minimize: \frac{1}{2}x^\top Q x + P^\top x + C$\
$$

Subject to:

$$
Ax \leq b, and Ex = d
$$

## Main body
For a nonlinear system, the CLF could be used to track a desired trajectory. In a 2D plane, a robot tries to go to a destination at G(x_g, y_g), the problem could be formalized as QP problem: 
$$\underset{u}{\text{min}}\|u - u_{\text{des}}\|_2$$

subject to
$$\text{Control boundary}: u_{\text{min}} \leq u \leq u_{\text{max}},$$
$$\text{CLF constraint}: \nabla V(x)^T f(x,u) \leq -\alpha V(x).$$

There are two caveats to solving this system, the relative order of the system cannot be greater than 1, and we need to carefully design the Lyapunov function to be convex for the finite time convergence of the system. In the case where the system has a relative order greater than 1, we could use the method mentioned in [1] to design a similar high-order control Lyapunov function to make the system solvable. 

**Example of the Dubin car system**

$$
\dot{z} = \begin{bmatrix}
V{\cos\theta} \\
V{\sin\theta}\\
0
\end{bmatrix} + \begin{bmatrix}
0 \\
0 \\
\omega
\end{bmatrix}
$$


$$
\text{Designed CLF: }
V(z) = (x - x_g)^2 + (y - y_g)^2
$$

$$
L_f V(z) = \nabla V(z)^T f(z)
$$

$$
= \begin{bmatrix}
2(x - x_g) & 2(y - y_g) & 0
\end{bmatrix} 
\begin{bmatrix}
\frac{V}{\cos\theta} \\
\frac{V}{\sin\theta}\\
0
\end{bmatrix}
$$

$$
= 2V \cos\theta (x - x_g) + 2V \sin\theta (y - y_g)
$$

From the relative degree definition, when m = 1, $L_g L_f^{m-2} V = 0 \Rightarrow L_g V(z) = 0 \Rightarrow$ relative degree is higher than 1. \
When the $m = 2, L_f^2 V(z) = L_f (L_g V(z)) = L_g (L_f V(z)) = -2V \sin\theta (x - x_g) + 2V \cos\theta (y - y_g) \neq 0$\
We can conclude that the relative degree of the system is 2.

In this case, the conventional CLF will not work due to the high relative degree. We can borrow the ideas from [1] of the Higher Order Control Barrier Function (HOCBF) to devise a system of high-order Control Lyapunov Function (HOCLF) with a relative degree 1 in between each of those functions to make the system solvable. 

Since the relative degree is 2, create an intermediate function $\psi(x)$ such that its first derivative $\dot{\psi}(x)$ includes the control input explicitly. One example of $\psi(x)$ is as follows:

$$
\psi(x) = L_f V(x) + \alpha_1(\psi_0(x))
$$

For $\psi(x)$, define the control law such that $\dot{\psi}(x) \leq -\alpha(\psi(x))$ where $\alpha$ is a class $\mathcal{K}$ function to ensure that $\psi(x)$ decreases over time, leading to the stabilization of the system. The control law can be defined using the HOCLF condition for the control input $u$ to ensure that the derivative of the HOCLF is negative. Ensure that the designed HOCLF satisfies the Lyapunov stability criteria, which typically means that the HOCLF should be positive definite and its derivative along the system's trajectories should be negative definite.

## Conclusion
Control Lyapunov Function could be used to ensure the convergence of the system to a goal location. In the case where the relative degree of the system is higher than 1, we could use the high-order control Lyapunov function to design a system of CLF equations with the relative degree being 1 to guarantee a control law that could influence the system effectively. In the case of tracking a trajectory while avoiding obstacles, we could use the CLF as one of the constraints to a QP problem. 

CLF is a powerful technique to design controllers that ensure the stability of an equilibrium point of a system. The HOCLF method involves creating a sequence of intermediate functions, each with a relative degree of one, such that the control input appears in the first derivative of the final function in the sequence. HOCLF allows for the construction of a control law that can stabilize the system even when the output of interest does not immediately respond to the control input

## References
[1] [High-Order Control Barrier Functions](https://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=9516971) \ by Wei Xiao \
[2] Leung, Karen. “Linear Multivariable Control” Lecture, University of Washington, Seattle, 2024-04-02.\
[3] Taghvaei, Amir. “Linear Control Systems” Lecture, University of Washington, Seattle, 2024-02-23.\
[4] [Control Barrier Functions for Systems with Multiple Control Inputs](https://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=9867612) \ by Wei Xiao \
